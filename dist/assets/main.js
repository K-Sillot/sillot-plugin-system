const path$3=require("path"),log=(...e)=>{console.log("[Plugin System] ",...e)},error=(...e)=>console.error("[Plugin System] ",...e),reloadWindow=()=>window.location.reload(),getCrossPlatformAppDataFolder=()=>{let e;return process.platform==="darwin"?e=path$3.join(PROCESS_ENV.HOME,"/Library/Application Support"):process.platform==="win32"?e=PROCESS_ENV.APPDATA:process.platform==="linux"&&(e=PROCESS_ENV.HOME),e},path$2=require("path"),PROCESS_ENV=window.process.env,SIYUAN_DATA_PATH=window.siyuan.config.system.dataDir,PLUGIN_FOLDER="plugins",VERSION="v0.2.1",VERSION_URL="https://gitee.com/zuoez02/siyuan-plugin-system/raw/main/VERSION",SCRIPT_URL="https://gitee.com/zuoez02/siyuan-plugin-system/raw/main/main.js",PLUGIN_SYS_ABS_PATH=path$2.join(getCrossPlatformAppDataFolder(),".siyuan","plugin.js"),config=()=>({token:window.siyuan.config.api.token}),fs$1=require("fs"),path$1=require("path"),pluginScriptPosition=PLUGIN_SYS_ABS_PATH;class PluginSystemLocalManager{saveToLocal(t,o){return new Promise((n,r)=>{const{writeFile:a}=fs$1,{Buffer:s}=require("buffer"),l=new Uint8Array(s.from(o));a(t,l,i=>{if(i)return r(i);n("The file has been saved!")})})}createFile(t){return new Promise((o,n)=>{fs$1.mkdir(path$1.dirname(t),{recursive:!0},r=>{if(r)return n(r);o("Directory created successfully!")})})}async localCacheInit(){try{fs$1.statSync(pluginScriptPosition),setTimeout(()=>{this.tryUpgrade()},1e3);return}catch{log("Plugin system not found")}const t=window.siyuanPluginScript;t&&(await this.createFile(pluginScriptPosition),await this.saveToLocal(pluginScriptPosition,t),setTimeout(()=>{this.tryUpgrade()},1e3))}async tryUpgrade(){log("Try getting online version");const t=await this.getOnlineVersion();t!==VERSION?(log("Online Version: "+t+", local version: "+VERSION),log("Downloading new version of Plugin System"),this.upgrade()):log("Version is "+VERSION+", OK")}async getOnlineVersion(){return fetch(VERSION_URL,{cache:"no-cache"}).then(t=>t.text())}async upgrade(){const t=await fetch(SCRIPT_URL,{cache:"no-cache"}).then(o=>o.text());t&&(await this.createFile(pluginScriptPosition),await this.saveToLocal(pluginScriptPosition,t),log("Plugin system upgraded, reloading..."),setTimeout(()=>reloadWindow(),3e3))}}class Plugin{onload(){}onunload(){}}async function request(e,t){let o=null;return await fetch(e,{body:JSON.stringify(t),method:"POST",headers:{Authorization:`Token ${config().token}`}}).then(function(n){o=n.json()}),o}async function parseBody(e){let t=await e;return t.code===0?t.data:null}async function transactions(e,t=[]){const o="/api/transactions",n=new URL(e.ws.ws.url),r={app:n.searchParams.get("app"),session:n.searchParams.get("id"),transactions:t};return parseBody(request(o,r))}async function sql(e){return parseBody(request("/api/query/sql",{stmt:e}))}async function lsNotebooks(e){return parseBody(request("/api/notebook/lsNotebooks",{stmt:e}))}async function getAnchor(e,t){e=e.replace("((","").replace("))","");let o=`select * from blocks where id = '${e}'`,n=await sql(o),r="";if(n)try{n[0][t]?r=n[0][t]:n[0].content?r=n[0].content:r=e}catch{r="解析错误"}return r}async function openNotebook(e){return parseBody(request("/api/notebook/openNotebook",{notebook:e}))}async function closeNotebook(e){return parseBody(request("/api/notebook/closeNotebook",{notebook:e}))}async function renameNotebook(e,t){return parseBody(request("/api/notebook/renameNotebook",{notebook:e,name:t}))}async function createNotebook(e){return parseBody(request("/api/notebook/createNotebook",{name:e}))}async function removeNotebook(e){return parseBody(request("/api/notebook/removeNotebook",{notebook:e}))}async function getNotebookConf(e){return parseBody(request("/api/notebook/getNotebookConf",{notebook:e}))}async function setNotebookConf(e){return parseBody(request("/api/notebook/setNotebookConf",{notebook:e}))}async function renameDoc(e,t,o){return parseBody(request("/api/filetree/renameDoc",{notebook:e,path:t,title:o}))}async function removeDoc(e,t){return parseBody(request("/api/filetree/removeDoc",{notebook:e,path:t}))}async function moveDoc(e,t,o,n){return parseBody(request("/api/filetree/moveDoc",{fromNotebook:e,fromPath:t,toNotebook:o,toPath:n}))}async function getHPathByPath(e,t){return parseBody(request("/api/filetree/getHPathByPath",{Notebook:e,Path:t}))}async function getHPathByID(e){return parseBody(request("/api/filetree/getHPathByID",{id:e}))}async function getBlockAttrs(e){return parseBody(request("/api/attr/getBlockAttrs",{id:e}))}async function getBlockByID(e){let t=`select * from blocks where id ='${e}'`;return(await sql(t))[0]}async function getBlockKramdown(e){return parseBody(request("/api/block/getBlockKramdown",{id:e}))}async function getBlockBreadcrumb(e){return parseBody(request("/api/block/getBlockBreadcrumb",{id:e}))}async function setBlockAttrs(e,t){return parseBody(request("/api/attr/setBlockAttrs",{id:e,attrs:t}))}async function exportMdContent(e){return parseBody(request("/api/export/exportMdContent",{id:e}))}async function getDocOutline(e){return parseBody(request("/api/outline/getDocOutline",{id:e}))}async function listDocsByPath(e){return parseBody(request("/api/filetree/listDocsByPath",{path:e}))}async function getBacklink(e){return parseBody(request("/api/ref/getBacklink",{id:e,beforeLen:10,k:"",mk:""}))}async function searchEmbedBlock(e,t){return parseBody(request("/api/search/searchEmbedBlock",{stmt:t,excludeIDs:e}))}async function getDoc(e){return parseBody(request("/api/filetree/getDoc",{id:e,k:"",mode:2,size:36}))}async function getFocusedDoc(e){return parseBody(request("/api/filetree/getDoc",{id:e,k:"",mode:0,size:36}))}async function getTag(){return parseBody(request("/api/tag/getTag",{}))}async function getLocalGraph(e,t,o,n){return parseBody(request("/api/graph/getLocalGraph",{id:t,k:e,conf:o,reqId:n}))}async function getGraph(e,t,o){return parseBody(request("/api/graph/getGraph",{k:e,conf:t,reqId:o}))}async function searchDocs(e){return parseBody(request("/api/filetree/searchDocs",{k:e}))}async function searchBlock(e){return parseBody(request("/api/search/searchBlock",{query:e}))}async function searchTemplate(e){return parseBody(request("/api/search/searchTemplate",{k:e}))}async function createDocWithMd(e,t,o){return parseBody(request("/api/filetree/createDocWithMd",{notebook:e,path:t,markdown:o}))}async function docSaveAsTemplate(e,t=!1){return parseBody(request("/api/template/docSaveAsTemplate",{id:e,overwrite:t}))}async function render(e){return parseBody(request("/api/template/render",e))}async function insertBlock(e,t,o){let n="/api/block/insertBlock";return parseBody(request(n=n,o={previousID:e,dataType:t,data:o}))}async function prependBlock(e,t,o){let n="/api/block/prependBlock";return parseBody(request(n=n,o={parentID:e,dataType:t,data:o}))}async function appendBlock(e,t,o){let n="/api/block/appendBlock";return parseBody(request(n=n,o={parentID:e,dataType:t,data:o}))}async function updateBlock(e,t,o){let n="/api/block/updateBlock";return parseBody(request(n=n,o={id:e,dataType:t,data:o}))}async function deleteBlock(e){return parseBody(request("/api/block/deleteBlock",{id:e}))}async function getSysFonts(){return parseBody(request("/api/system/getSysFonts",null))}async function getFile(e){const t=await fetch("/api/file/getFile",{method:"POST",headers:{Authorization:`Token ${config().token}`},body:JSON.stringify({path:e})});return t.status===200?t:null}async function putFile(e,t,o=!1,n=Date.now()){let r=new Blob([t]),a=new File([r],e.split("/").pop()),s=new FormData;s.append("path",e),s.append("file",a),s.append("isDir",String(o)),s.append("modTime",String(n));const l=await fetch("/api/file/putFile",{body:s,method:"POST",headers:{Authorization:`Token ${config().token}`}});return l.status===200?await l.json():null}var u;const language=(u=window.theme)==null?void 0:u.languageMode;async function pushMsg(e=null,t=null,o=7e3){const n="/api/notification/pushMsg",r={msg:e?e[language]||e.other:t,timeout:o};return parseBody(request(n,r))}async function pushErrMsg(e=null,t=null,o=7e3){const n="/api/notification/pushErrMsg",r={msg:e?e[language]||e.other:t,timeout:o};return parseBody(request(n,r))}const serverApi=Object.freeze(Object.defineProperty({__proto__:null,appendBlock,closeNotebook,createDocWithMd,createNotebook,deleteBlock,docSaveAsTemplate,exportMdContent,getAnchor,getBacklink,getBlockAttrs,getBlockBreadcrumb,getBlockByID,getBlockKramdown,getDoc,getDocOutline,getFile,getFocusedDoc,getGraph,getHPathByID,getHPathByPath,getLocalGraph,getNotebookConf,getSysFonts,getTag,insertBlock,listDocsByPath,lsNotebooks,moveDoc,openNotebook,parseBody,prependBlock,pushErrMsg,pushMsg,putFile,removeDoc,removeNotebook,renameDoc,renameNotebook,render,request,searchBlock,searchDocs,searchEmbedBlock,searchTemplate,setBlockAttrs,setNotebookConf,sql,transactions,updateBlock},Symbol.toStringTag,{value:"Module"})),apiGenerate=()=>({addToolbarLeft:()=>{console.log("add toolbar left")},addToolbarRight:()=>{console.log("add toolbar right")},serverApi});class BaseComponent{}const modules={Plugin,BaseComponent},fs=require("fs"),path=require("path"),MANIFEST="manifest.json",SCRIPT="main.js",scanPlugins=async e=>new Promise((t,o)=>{fs.readdir(e,(n,r)=>{if(n){o(n);return}t(r.map(a=>path.resolve(e,a)))})}),getFileContent=async e=>new Promise((t,o)=>{fs.readFile(e,(n,r)=>{if(n){o(n);return}return t(r.toString("utf8"))})}),getManifest=async e=>{const t=await getFileContent(e);try{return JSON.parse(t)}catch(o){error("loading manifest: "+e,o)}},getScript=async e=>await getFileContent(e),getAllPlugins=async()=>{const e=await scanPlugins(path.join(SIYUAN_DATA_PATH,PLUGIN_FOLDER));if(!e||!e.length){log("No plugin found in "+path.join(SIYUAN_DATA_PATH,PLUGIN_FOLDER));return}const t=[];for(const o of e){log("Loading plugin: "+o);const[n,r]=await Promise.all([getManifest(path.join(o,MANIFEST)),getScript(path.join(o,SCRIPT))]);t.push({...n,script:r})}return t};let components;class PluginLoader{constructor(){this.plugins=new Map}async loadAllLocalPlugins(){const e=await getAllPlugins();if(e)for(const t of e)await this.loadPlugin(t)}async loadPlugin(plugin){components||this.generateRequiredModules();const exports={},module={exports};function run(script,name){return eval("(function anonymous(require,module,exports){".concat(script,`
})
//# sourceURL=`).concat(name,`
`))}const __require=e=>{if(components[e])return components[e];throw new Error(`module ${e} not found`)},pluginName=plugin.name;run(plugin.script,plugin.name)(__require,module,exports);let pluginConstructor;if(!(pluginConstructor=(module.exports||exports).default||module.exports))throw new Error(`Failed to load plugin ${pluginName}. No exports detected.`);const plug=new pluginConstructor;if(!(plug instanceof Plugin))throw new Error(`Failed to load plugin ${pluginName}`);plug.onload(),this.plugins.set(pluginName,plug)}async unloadPlugin(e){const t=this.plugins.get(e);t&&(await t.onunload(),this.plugins.delete(e))}generateRequiredModules(){components={siyuan:{...modules,...apiGenerate()}}}}class PluginSystem{constructor(){this.pluginLoader=new PluginLoader,this.pslm=new PluginSystemLocalManager}init(){return this.pluginLoader.loadAllLocalPlugins(),this.pslm.localCacheInit(),this}}window.pluginSystem||(log("Siyuan Plugin System loading..."),window.pluginSystemVersion=VERSION,window.pluginSystem=new PluginSystem().init());
