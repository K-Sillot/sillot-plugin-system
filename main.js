(function(){var _a;const path$3=require("path"),log=(...e)=>{console.log("[Plugin System] ",...e)},error=(...e)=>console.error("[Plugin System] ",...e),reloadWindow=()=>window.location.reload(),getCrossPlatformAppDataFolder=()=>{let e;return"darwin"===process.platform?e=path$3.join(PROCESS_ENV.HOME,"/Library/Application Support"):"win32"===process.platform?e=PROCESS_ENV.APPDATA:"linux"===process.platform&&(e=PROCESS_ENV.HOME),e},path$2=require("path"),PROCESS_ENV=window.process.env,SIYUAN_DATA_PATH=window.siyuan.config.system.dataDir,PLUGIN_FOLDER="plugins",VERSION="v0.3.1",VERSION_URL="https://gitee.com/zuoez02/siyuan-plugin-system/raw/main/VERSION",SCRIPT_URL="https://gitee.com/zuoez02/siyuan-plugin-system/raw/main/main.js",PLUGIN_SYS_ABS_PATH=path$2.join(getCrossPlatformAppDataFolder(),".siyuan","plugin.js"),config=()=>({token:window.siyuan.config.api.token}),fs$1=require("fs"),path$1=require("path"),pluginScriptPosition=PLUGIN_SYS_ABS_PATH;class PluginSystemLocalManager{saveToLocal(e,t){return new Promise(((o,n)=>{const{writeFile:r}=fs$1,{Buffer:a}=require("buffer"),s=new Uint8Array(a.from(t));r(e,s,(e=>{if(e)return n(e);o("The file has been saved!")}))}))}createFile(e){return new Promise(((t,o)=>{fs$1.mkdir(path$1.dirname(e),{recursive:!0},(e=>{if(e)return o(e);t("Directory created successfully!")}))}))}async localCacheInit(){try{return fs$1.statSync(pluginScriptPosition),void setTimeout((()=>{this.tryUpgrade()}),1e3)}catch(t){log("Plugin system not found")}const e=window.siyuanPluginScript;e&&(await this.createFile(pluginScriptPosition),await this.saveToLocal(pluginScriptPosition,e),setTimeout((()=>{this.tryUpgrade()}),1e3))}async tryUpgrade(){log("Try getting online version");const e=await this.getOnlineVersion();e!==VERSION?(log("Online Version: "+e+", local version: "+VERSION),log("Downloading new version of Plugin System"),this.upgrade()):log("Version is "+VERSION+", OK")}async getOnlineVersion(){return fetch(VERSION_URL,{cache:"no-cache"}).then((e=>e.text()))}async upgrade(){const e=await fetch(SCRIPT_URL,{cache:"no-cache"}).then((e=>e.text()));e&&(await this.createFile(pluginScriptPosition),await this.saveToLocal(pluginScriptPosition,e),log("Plugin system upgraded, reloading..."),setTimeout((()=>reloadWindow()),3e3))}}class Plugin{onload(){}onunload(){}}async function request(e,t){let o=null;return await fetch(e,{body:JSON.stringify(t),method:"POST",headers:{Authorization:`Token ${config().token}`}}).then((function(e){o=e.json()})),o}async function parseBody(e){let t=await e;return 0===t.code?t.data:null}async function transactions(e,t=[]){const o=new URL(e.ws.ws.url);return parseBody(request("/api/transactions",{app:o.searchParams.get("app"),session:o.searchParams.get("id"),transactions:t}))}async function sql(e){return parseBody(request("/api/query/sql",{stmt:e}))}async function lsNotebooks(e){return parseBody(request("/api/notebook/lsNotebooks",{stmt:e}))}async function getAnchor(e,t){let o=`select * from blocks where id = '${e=e.replace("((","").replace("))","")}'`,n=await sql(o),r="";if(n)try{r=n[0][t]?n[0][t]:n[0].content?n[0].content:e}catch(a){r="解析错误"}return r}async function openNotebook(e){return parseBody(request("/api/notebook/openNotebook",{notebook:e}))}async function closeNotebook(e){return parseBody(request("/api/notebook/closeNotebook",{notebook:e}))}async function renameNotebook(e,t){return parseBody(request("/api/notebook/renameNotebook",{notebook:e,name:t}))}async function createNotebook(e){return parseBody(request("/api/notebook/createNotebook",{name:e}))}async function removeNotebook(e){return parseBody(request("/api/notebook/removeNotebook",{notebook:e}))}async function getNotebookConf(e){return parseBody(request("/api/notebook/getNotebookConf",{notebook:e}))}async function setNotebookConf(e){return parseBody(request("/api/notebook/setNotebookConf",{notebook:e}))}async function renameDoc(e,t,o){return parseBody(request("/api/filetree/renameDoc",{notebook:e,path:t,title:o}))}async function removeDoc(e,t){return parseBody(request("/api/filetree/removeDoc",{notebook:e,path:t}))}async function moveDoc(e,t,o,n){return parseBody(request("/api/filetree/moveDoc",{fromNotebook:e,fromPath:t,toNotebook:o,toPath:n}))}async function getHPathByPath(e,t){return parseBody(request("/api/filetree/getHPathByPath",{Notebook:e,Path:t}))}async function getHPathByID(e){return parseBody(request("/api/filetree/getHPathByID",{id:e}))}async function getBlockAttrs(e){return parseBody(request("/api/attr/getBlockAttrs",{id:e}))}async function getBlockByID(e){let t=`select * from blocks where id ='${e}'`;return(await sql(t))[0]}async function getBlockKramdown(e){return parseBody(request("/api/block/getBlockKramdown",{id:e}))}async function getBlockBreadcrumb(e){return parseBody(request("/api/block/getBlockBreadcrumb",{id:e}))}async function setBlockAttrs(e,t){return parseBody(request("/api/attr/setBlockAttrs",{id:e,attrs:t}))}async function exportMdContent(e){return parseBody(request("/api/export/exportMdContent",{id:e}))}async function getDocOutline(e){return parseBody(request("/api/outline/getDocOutline",{id:e}))}async function listDocsByPath(e){return parseBody(request("/api/filetree/listDocsByPath",{path:e}))}async function getBacklink(e){return parseBody(request("/api/ref/getBacklink",{id:e,beforeLen:10,k:"",mk:""}))}async function searchEmbedBlock(e,t){return parseBody(request("/api/search/searchEmbedBlock",{stmt:t,excludeIDs:e}))}async function getDoc(e){return parseBody(request("/api/filetree/getDoc",{id:e,k:"",mode:2,size:36}))}async function getFocusedDoc(e){return parseBody(request("/api/filetree/getDoc",{id:e,k:"",mode:0,size:36}))}async function getTag(){return parseBody(request("/api/tag/getTag",{}))}async function getLocalGraph(e,t,o,n){return parseBody(request("/api/graph/getLocalGraph",{id:t,k:e,conf:o,reqId:n}))}async function getGraph(e,t,o){return parseBody(request("/api/graph/getGraph",{k:e,conf:t,reqId:o}))}async function searchDocs(e){return parseBody(request("/api/filetree/searchDocs",{k:e}))}async function searchBlock(e){return parseBody(request("/api/search/searchBlock",{query:e}))}async function searchTemplate(e){return parseBody(request("/api/search/searchTemplate",{k:e}))}async function createDocWithMd(e,t,o){return parseBody(request("/api/filetree/createDocWithMd",{notebook:e,path:t,markdown:o}))}async function docSaveAsTemplate(e,t=!1){return parseBody(request("/api/template/docSaveAsTemplate",{id:e,overwrite:t}))}async function render(e){return parseBody(request("/api/template/render",e))}async function insertBlock(e,t,o){let n="/api/block/insertBlock";return parseBody(request(n,o={previousID:e,dataType:t,data:o}))}async function prependBlock(e,t,o){let n="/api/block/prependBlock";return parseBody(request(n,o={parentID:e,dataType:t,data:o}))}async function appendBlock(e,t,o){let n="/api/block/appendBlock";return parseBody(request(n,o={parentID:e,dataType:t,data:o}))}async function updateBlock(e,t,o){let n="/api/block/updateBlock";return parseBody(request(n,o={id:e,dataType:t,data:o}))}async function deleteBlock(e){return parseBody(request("/api/block/deleteBlock",{id:e}))}async function getSysFonts(){return parseBody(request("/api/system/getSysFonts",null))}async function getFile(e){const t=await fetch("/api/file/getFile",{method:"POST",headers:{Authorization:`Token ${config().token}`},body:JSON.stringify({path:e})});return 200===t.status?t:null}async function putFile(e,t,o=!1,n=Date.now()){let r=new Blob([t]),a=new File([r],e.split("/").pop()),s=new FormData;s.append("path",e),s.append("file",a),s.append("isDir",String(o)),s.append("modTime",String(n));const i=await fetch("/api/file/putFile",{body:s,method:"POST",headers:{Authorization:`Token ${config().token}`}});return 200===i.status?await i.json():null}const language=null==(_a=window.theme)?void 0:_a.languageMode;async function pushMsg(e=null,t=null,o=7e3){return parseBody(request("/api/notification/pushMsg",{msg:e?e[language]||e.other:t,timeout:o}))}async function pushErrMsg(e=null,t=null,o=7e3){return parseBody(request("/api/notification/pushErrMsg",{msg:e?e[language]||e.other:t,timeout:o}))}const serverApi=Object.freeze(Object.defineProperty({__proto__:null,appendBlock:appendBlock,closeNotebook:closeNotebook,createDocWithMd:createDocWithMd,createNotebook:createNotebook,deleteBlock:deleteBlock,docSaveAsTemplate:docSaveAsTemplate,exportMdContent:exportMdContent,getAnchor:getAnchor,getBacklink:getBacklink,getBlockAttrs:getBlockAttrs,getBlockBreadcrumb:getBlockBreadcrumb,getBlockByID:getBlockByID,getBlockKramdown:getBlockKramdown,getDoc:getDoc,getDocOutline:getDocOutline,getFile:getFile,getFocusedDoc:getFocusedDoc,getGraph:getGraph,getHPathByID:getHPathByID,getHPathByPath:getHPathByPath,getLocalGraph:getLocalGraph,getNotebookConf:getNotebookConf,getSysFonts:getSysFonts,getTag:getTag,insertBlock:insertBlock,listDocsByPath:listDocsByPath,lsNotebooks:lsNotebooks,moveDoc:moveDoc,openNotebook:openNotebook,parseBody:parseBody,prependBlock:prependBlock,pushErrMsg:pushErrMsg,pushMsg:pushMsg,putFile:putFile,removeDoc:removeDoc,removeNotebook:removeNotebook,renameDoc:renameDoc,renameNotebook:renameNotebook,render:render,request:request,searchBlock:searchBlock,searchDocs:searchDocs,searchEmbedBlock:searchEmbedBlock,searchTemplate:searchTemplate,setBlockAttrs:setBlockAttrs,setNotebookConf:setNotebookConf,sql:sql,transactions:transactions,updateBlock:updateBlock},Symbol.toStringTag,{value:"Module"}));function insertBefore(e,t){return e.insertAdjacentElement("beforebegin",t)}function insertAfter(e,t){return e.insertAdjacentElement("afterend",t)}function addToolbarLeft(e){var t;const o=null==(t=document.getElementById("toolbar"))?void 0:t.getElementsByClassName("fn__ellipsis");o&&insertBefore(o[0],e)}function addToolbarRight(e){var t;const o=null==(t=document.getElementById("toolbar"))?void 0:t.getElementsByClassName("fn__ellipsis");o&&insertAfter(o[0],e)}const clientApi=Object.freeze(Object.defineProperty({__proto__:null,addToolbarLeft:addToolbarLeft,addToolbarRight:addToolbarRight},Symbol.toStringTag,{value:"Module"})),apiGenerate=()=>({clientApi:clientApi,serverApi:serverApi});class BaseComponent{}const modules={Plugin:Plugin,BaseComponent:BaseComponent},fs=require("fs"),path=require("path"),MANIFEST="manifest.json",SCRIPT="main.js",scanPlugins=async e=>new Promise(((t,o)=>{fs.readdir(e,((n,r)=>{n?o(n):t(r.map((t=>path.resolve(e,t))))}))})),getFileContent=async e=>new Promise(((t,o)=>{fs.readFile(e,((e,n)=>{if(!e)return t(n.toString("utf8"));o(e)}))})),getManifest=async e=>{const t=await getFileContent(e);try{return JSON.parse(t)}catch(o){error("loading manifest: "+e,o)}},getScript=async e=>await getFileContent(e),getAllPlugins=async()=>{const e=await scanPlugins(path.join(SIYUAN_DATA_PATH,PLUGIN_FOLDER));if(!e||!e.length)return void log("No plugin found in "+path.join(SIYUAN_DATA_PATH,PLUGIN_FOLDER));const t=[];for(const o of e){log("Loading plugin: "+o);const[e,n]=await Promise.all([getManifest(path.join(o,MANIFEST)),getScript(path.join(o,SCRIPT))]);t.push({...e,script:n})}return t};let components;class PluginLoader{constructor(){this.plugins=new Map}async loadAllLocalPlugins(){const e=await getAllPlugins();if(e)for(const t of e)await this.loadPlugin(t)}async loadPlugin(plugin){components||this.generateRequiredModules();const exports={},module={exports:exports};function run(script,name){return eval("(function anonymous(require,module,exports){".concat(script,"\n})\n//# sourceURL=").concat(name,"\n"))}const __require=e=>{if(components[e])return components[e];throw new Error(`module ${e} not found`)},pluginName=plugin.name;let pluginConstructor;if(run(plugin.script,plugin.name)(__require,module,exports),!(pluginConstructor=(module.exports||exports).default||module.exports))throw new Error(`Failed to load plugin ${pluginName}. No exports detected.`);const plug=new pluginConstructor;if(!(plug instanceof Plugin))throw new Error(`Failed to load plugin ${pluginName}`);plug.onload(),this.plugins.set(pluginName,plug)}async unloadPlugin(e){const t=this.plugins.get(e);t&&(await t.onunload(),this.plugins.delete(e))}generateRequiredModules(){components={siyuan:{...modules,...apiGenerate()}}}}class PluginSystem{constructor(){this.pluginLoader=new PluginLoader,this.pslm=new PluginSystemLocalManager}init(){return this.pluginLoader.loadAllLocalPlugins(),this.pslm.localCacheInit(),this}}window.pluginSystem||(log("Siyuan Plugin System loading..."),window.pluginSystemVersion=VERSION,window.pluginSystem=(new PluginSystem).init());
})()